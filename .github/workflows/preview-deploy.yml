name: Preview Deploy

on:
  pull_request:
    branches: [main]

jobs:
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      - name: Install Turso CLI
        run: |
          curl -sSfL https://get.tur.so/install.sh | bash
          echo "$HOME/.turso" >> "$GITHUB_PATH"

      - name: Create per-PR database
        run: |
          DB_NAME="cerberus-pr-${{ github.event.pull_request.number }}"
          if turso db show "$DB_NAME" &>/dev/null; then
            echo "Database $DB_NAME already exists, reusing"
          else
            turso db create "$DB_NAME"
          fi
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}

      - name: Get database credentials
        id: db-creds
        run: |
          DB_NAME="cerberus-pr-${{ github.event.pull_request.number }}"
          DB_URL=$(turso db show "$DB_NAME" --url)
          DB_TOKEN=$(turso db tokens create "$DB_NAME")
          echo "::add-mask::$DB_TOKEN"
          echo "url=$DB_URL" >> "$GITHUB_OUTPUT"
          echo "token=$DB_TOKEN" >> "$GITHUB_OUTPUT"
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}

      - name: Push database schema
        working-directory: packages/api
        run: npx drizzle-kit push
        env:
          TURSO_DATABASE_URL: ${{ steps.db-creds.outputs.url }}
          TURSO_AUTH_TOKEN: ${{ steps.db-creds.outputs.token }}

      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: packages/api
        run: npx wrangler deploy --name cerberus-preview-pr-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Set preview worker secrets
        working-directory: packages/api
        run: |
          echo "${{ steps.db-creds.outputs.url }}" | npx wrangler secret put TURSO_DATABASE_URL --name cerberus-preview-pr-${{ github.event.pull_request.number }}
          echo "${{ steps.db-creds.outputs.token }}" | npx wrangler secret put TURSO_AUTH_TOKEN --name cerberus-preview-pr-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://cerberus-preview-pr-${prNumber}.alexandre-leroy.workers.dev`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Preview deployed: ${previewUrl}`
            });
