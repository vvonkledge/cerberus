name: Preview Deploy

on:
  pull_request:
    branches: [main]

jobs:
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      - name: Push database schema
        working-directory: packages/api
        run: npx drizzle-kit push
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_PREVIEW_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_PREVIEW_AUTH_TOKEN }}

      - name: Deploy to Cloudflare Workers
        id: deploy
        working-directory: packages/api
        run: npx wrangler deploy --name cerberus-preview-pr-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Set preview worker secrets
        working-directory: packages/api
        run: |
          echo "${{ secrets.TURSO_PREVIEW_DATABASE_URL }}" | npx wrangler secret put TURSO_DATABASE_URL --name cerberus-preview-pr-${{ github.event.pull_request.number }}
          echo "${{ secrets.TURSO_PREVIEW_AUTH_TOKEN }}" | npx wrangler secret put TURSO_AUTH_TOKEN --name cerberus-preview-pr-${{ github.event.pull_request.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://cerberus-preview-pr-${prNumber}.alexandre-leroy.workers.dev`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Preview deployed: ${previewUrl}`
            });
