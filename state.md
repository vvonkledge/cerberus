# State

## Goal

Implement core auth flows (register, login, token issue/validate) with a working admin dashboard for role and permission management.

## Position

Monorepo with packages/api and packages/dashboard deployed as a single Cloudflare Worker. CI/CD pipeline runs lint and tests on PRs, deploys per-PR previews with dynamically created Turso databases, auto-deploys staging on merge to main, and deploys production on tag. Each deploy runs `drizzle-kit push` against its environment's Turso database. A cleanup workflow destroys the per-PR database and preview worker on PR close. The per-PR database workflow has been statically verified but not E2E tested — a `TURSO_API_TOKEN` secret must be configured before live testing. Users, refresh_tokens, roles, permissions, role_permissions, and user_roles tables exist. POST /register creates users with PBKDF2-hashed passwords. POST /login verifies credentials and returns an OAuth 2.0-compatible JWT access token (HMAC-SHA256, 1-hour expiry) alongside an opaque refresh token (7-day expiry). POST /refresh exchanges a valid refresh token for a new access token and a new refresh token, revoking the old refresh token (token rotation), and performs eager cleanup of all revoked and expired tokens for that user. POST /revoke invalidates a refresh token. POST /login, POST /register, and POST /refresh are rate-limited via sliding window (10/60s, 5/60s, 10/60s respectively) using Cloudflare KV with in-memory fallback; rate-limited responses include X-RateLimit-Limit, X-RateLimit-Remaining, and X-RateLimit-Reset headers. The KV namespace ID in wrangler.jsonc is a placeholder — must be replaced with an actual namespace before deploying. All RBAC endpoints (POST /roles, GET /roles, POST /roles/:roleId/permissions, GET /users, POST /users/:userId/roles, GET /users/:userId/permissions) require a valid JWT via auth middleware and a valid permission via requirePermission authorization middleware — requests without a valid Bearer token receive 401, requests from users lacking the required permission (manage_roles for role endpoints, manage_users for user endpoints) receive 403. POST /seed bootstraps an admin role with manage_roles and manage_users permissions and assigns it to a specified user; it requires no authentication and returns 409 if the admin role already exists. All crypto uses Web Crypto API with zero external dependencies. JWT_SECRET must be configured as a Workers secret for staging and production. 85 API tests and 7 dashboard tests pass (92 total); 27 of the API tests are E2E journey tests covering the full auth lifecycle (register → login → refresh → revoke), admin RBAC setup (seed → roles → permissions → user-roles → permission resolution), and error paths (invalid credentials, expired/revoked tokens, 401/403 authorization). React dashboard has a login page, four protected pages (roles list with create form, role detail with permission assignment, users list, user detail with role assignment and resolved permissions view), and a navigation layout with logout button. Dashboard authentication uses an AuthContext provider storing the JWT in React state (not persisted across sessions); a ProtectedRoute component redirects unauthenticated users to /login; all API calls use a useApiFetch hook that injects the Authorization: Bearer header. No delete/edit operations for roles or assignments exist. No token refresh or automatic 401 handling in the dashboard — users must manually re-login when tokens expire. No admin bootstrap flow in the dashboard — POST /seed must be called via curl. The refresh_tokens table is cleaned up for active users during rotation; inactive users' expired tokens still accumulate.

## Log

- **Cycle 01:** Set up pnpm monorepo with Hono API and React dashboard. All dev, lint, and test scripts work. See `cycles/01/`
- **Cycle 02:** Added Turso database layer with Drizzle ORM and libsql adapter. Local dev via turso dev CLI, tests via in-memory SQLite, Workers compatibility confirmed. See `cycles/02/`
- **Cycle 03:** Added CI/CD pipeline with GitHub Actions: PR checks (lint + test), per-PR preview deploys, staging on merge to main, production on tag. Hono + React deployed as a single Cloudflare Worker. All 4 criteria verified end-to-end. See `cycles/03/`
- **Cycle 04:** Configured Turso databases for preview, staging, and production. CI/CD deploys now run `drizzle-kit push` before each deploy, and the health endpoint verifies DB connectivity on all environments. See `cycles/04/`
- **Cycle 05:** Implemented per-PR Turso database lifecycle in preview deploys. Cleanup workflow destroys database and worker on PR close. See `cycles/05/`
- **Cycle 06:** Implemented user registration and login with OAuth 2.0-compatible JWT access tokens. All crypto via Web Crypto API with zero new dependencies. All 5 success criteria met with 12 passing tests. See `cycles/06/`
- **Cycle 07:** Added refresh token support with 7-day expiry and revocation. 19 tests pass with zero regressions. See `cycles/07/`
- **Cycle 08:** Added RBAC data model with roles, permissions, and join tables. Four new endpoints for role creation, permission assignment, user-role assignment, and permission resolution. 29 tests pass with zero regressions. See `cycles/08/`
- **Cycle 09:** Built admin dashboard with React Router for RBAC management. All 5 success criteria met with 35 passing tests. See `cycles/09/`
- **Cycle 10:** Added refresh token rotation via revoke-and-reissue. POST /refresh now returns a new refresh token alongside the access token, with the old token invalidated. 37 API tests pass with zero regressions. See `cycles/10/`
- **Cycle 11:** Added eager cleanup of stale refresh tokens during rotation. POST /refresh now deletes all revoked and expired tokens for the user after issuing a new token. 38 API tests pass with zero regressions. See `cycles/11/`
- **Cycle 12:** Added sliding window rate limiting to POST /login (10/60s), POST /register (5/60s), and POST /refresh (10/60s) with Cloudflare KV storage and in-memory fallback. All 7 success criteria met with 44 API tests passing (6 new), zero regressions. See `cycles/12/`
- **Cycle 13:** Added JWT auth middleware to all RBAC endpoints. Requests without a valid Bearer token now receive 401. All 4 success criteria met with 50 API tests passing (6 new), zero regressions. See `cycles/13/`
- **Cycle 14:** Added role-based authorization to all RBAC endpoints via requirePermission middleware. POST /seed bootstraps admin role with manage_roles and manage_users permissions. All 4 success criteria met with 58 API tests passing (8 new), zero regressions. See `cycles/14/`
- **Cycle 15:** Added 27 E2E journey tests across 3 files validating all user-facing API workflows (auth lifecycle, admin RBAC setup, error paths). All 3 success criteria met with 85 API tests passing (27 new), zero regressions. See `cycles/15/`
- **Cycle 16:** Added dashboard authentication with login page, protected routes, and JWT-bearing API calls via AuthContext provider and useApiFetch hook. All 4 success criteria met with 92 tests passing (7 new dashboard, 85 API), zero regressions. See `cycles/16/`
