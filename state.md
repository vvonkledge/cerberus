# State

## Goal

Implement core auth flows (register, login, token issue/validate) with a working admin dashboard for role and permission management.

## Position

Monorepo with packages/api and packages/dashboard deployed as a single Cloudflare Worker. CI/CD pipeline runs lint and tests on PRs, deploys per-PR previews with dynamically created Turso databases, auto-deploys staging on merge to main, and deploys production on tag. Each deploy runs `drizzle-kit push` against its environment's Turso database. A cleanup workflow destroys the per-PR database and preview worker on PR close. The per-PR database workflow has been statically verified but not E2E tested — a `TURSO_API_TOKEN` secret must be configured before live testing. Users, refresh_tokens, roles, permissions, role_permissions, user_roles, password_reset_tokens, audit_logs, and api_keys tables exist. POST /register creates users with PBKDF2-hashed passwords. POST /login verifies credentials and returns an OAuth 2.0-compatible JWT access token (HMAC-SHA256, 1-hour expiry) alongside an opaque refresh token (7-day expiry). POST /refresh exchanges a valid refresh token for a new access token and a new refresh token, revoking the old refresh token (token rotation), and performs eager cleanup of all revoked and expired tokens for that user. POST /revoke invalidates a refresh token. POST /forgot-password accepts an email, generates an opaque reset token (32-byte hex, 1-hour expiry) stored in password_reset_tokens, and returns it in the response; returns 200 with a generic message for non-existent emails to prevent user enumeration. POST /reset-password validates a reset token (exists, not expired, not used), hashes the new password with PBKDF2, updates the user's password, and marks the token as used; all failure modes return the same generic error message while logging specific reasons in audit metadata. POST /login, POST /register, and POST /refresh are rate-limited via sliding window (10/60s, 5/60s, 10/60s respectively) using Cloudflare KV with in-memory fallback; rate-limited responses include X-RateLimit-Limit, X-RateLimit-Remaining, and X-RateLimit-Reset headers. POST /forgot-password and POST /reset-password are not rate-limited. The KV namespace ID in wrangler.jsonc is a placeholder — must be replaced with an actual namespace before deploying. POST /api-keys creates a prefixed API key (crb_<64 hex chars>), hashes it with SHA-256, stores the hash in api_keys, and returns the raw key exactly once; GET /api-keys lists the authenticated user's keys (id, name, keyPrefix, createdAt, revokedAt — never the hash or raw key); DELETE /api-keys/:keyId soft-revokes by setting revokedAt (owner-only, returns 404 for other users' keys). The auth middleware accepts both JWT and API key Bearer tokens — tokens starting with `crb_` are hashed and looked up by keyHash in the api_keys table; revoked keys return 401; non-crb_ tokens fall through to JWT verification. API key endpoints require authentication but no specific permission — any authenticated user manages their own keys. Full CRUD for roles: POST /roles creates, GET /roles lists, PUT /roles/:roleId renames, DELETE /roles/:roleId removes (returns 409 if role is still assigned to users — no cascade delete; also cleans up role_permissions). POST /roles/:roleId/permissions assigns permissions to roles. Full CRD for user-role assignments: POST /users/:userId/roles assigns, DELETE /users/:userId/roles/:roleId unassigns. GET /users lists all users. GET /users/:userId/permissions returns both resolved permissions and assigned roles. All RBAC endpoints require a valid JWT via auth middleware and a valid permission via requirePermission authorization middleware — requests without a valid Bearer token receive 401, requests from users lacking the required permission (manage_roles for role endpoints, manage_users for user endpoints) receive 403. POST /seed bootstraps an admin role with manage_roles and manage_users permissions and assigns it to a specified user; it requires a valid ADMIN_SETUP_TOKEN via the X-Setup-Token request header (returns 401 if missing, wrong, or env var unconfigured) and returns 409 if the admin role already exists. ADMIN_SETUP_TOKEN must be configured as a Workers secret alongside JWT_SECRET for staging and production. All auth endpoints (register, login, refresh, revoke), password reset endpoints (forgot-password, reset-password), and API key endpoints (create, revoke) write audit log entries to the audit_logs table via a centralized writeAuditLog utility; login failures record event_type='login_failed' with the attempted email in metadata; password reset events use event types password_reset_requested, password_reset_completed, and password_reset_failed with reasons in metadata; API key events use event types api_key_created and api_key_revoked with key name/prefix/id in metadata. The requirePermission authorization middleware writes authz_granted and authz_denied audit entries with the checked permission name in metadata. GET /audit-logs returns paginated audit entries (default 20 per page, max 100) ordered by timestamp descending with optional event_type query filter; it requires auth + manage_users permission. Audit logging is best-effort — writeAuditLog silently catches errors so a logging failure never breaks the main operation. All crypto uses Web Crypto API with zero external dependencies. JWT_SECRET must be configured as a Workers secret for staging and production. 154 API tests and 66 dashboard tests pass (220 total); 27 of the API tests are E2E journey tests covering the full auth lifecycle (register → login → refresh → revoke), admin RBAC setup (seed → roles → permissions → user-roles → permission resolution), and error paths (invalid credentials, expired/revoked tokens, 401/403 authorization); 18 audit-log tests cover auth event logging, authorization event logging, GET /audit-logs pagination/filtering/auth, and field completeness; 13 password-reset tests cover forgot-password happy path and enumeration prevention, reset-password with valid/expired/used/invalid tokens, login verification after reset, and audit log entries; 17 api-keys tests cover key creation (crb_ prefix, unique keys), listing (masked values), revocation (soft delete, owner-only), API key authentication (valid, revoked, invalid), JWT coexistence, and audit log verification; 10 audit-logs dashboard tests cover table rendering, pagination controls, event_type filter dropdown, loading/empty/error states; 11 api-keys dashboard tests cover list rendering (table columns, active/revoked status), create flow (POST call, raw key display, dismiss button), revoke flow (DELETE call, no button for revoked keys), and edge states (loading, empty, error); 10 setup dashboard tests cover heading and button rendering, seeding/disabled state, already-configured state (message shown, no button), POST /seed call with JWT-extracted userId, navigation on success, 409 handling, network error, and missing token; 6 sidebar tests cover rendering, link presence for all 5 top-level pages, link text, NavLink active-state className callback, and absence of detail-page links. React dashboard has a login page, seven protected pages (roles list with create form, role detail with permission assignment and rename form and delete button, users list, user detail with role assignment with remove buttons and resolved permissions view, audit logs with paginated table and event_type filter dropdown, API keys with list table and create form and revoke button and one-time raw key display, setup with admin bootstrap button that decodes JWT to extract userId and calls POST /seed with optimistic pattern — always shows bootstrap button and handles 409 as already-configured with message and no button), a top navigation bar with Cerberus branding and logout button, and a sidebar navigation component using NavLink with active-state highlighting for 5 top-level pages (Roles, Users, Audit Logs, API Keys, Setup) rendered alongside content via flexbox in the Layout component. Dashboard authentication uses an AuthContext provider storing both the JWT access token and an opaque refresh token in React state, persisted to localStorage via a tokenStorage module; on page load, AuthProvider initializes from localStorage so auth survives browser reloads and new tabs. A ProtectedRoute component redirects unauthenticated users to /login; all API calls use a useApiFetch hook that injects the Authorization: Bearer header and automatically intercepts 401 responses — on 401, useApiFetch calls POST /refresh with the stored refresh token, updates both tokens in state and localStorage on success and retries the original request, or calls logout (which clears localStorage) on failure. The audit logs page hardcodes 10 known event types in its filter dropdown but does not yet include api_key_created and api_key_revoked; this list must be updated manually when new event types are added to the system. No API key scopes, per-key permissions, expiration, or rotation exist. No edit/delete operations for permissions themselves exist. No dashboard UI for password reset — POST /forgot-password and POST /reset-password must be called via API client. The forgot-password endpoint returns the reset token directly in the response body; this API contract will need a breaking change when email delivery is added. Concurrent 401s are not deduplicated — simultaneous expired-token requests each independently attempt a refresh. The refresh_tokens table is cleaned up for active users during rotation; inactive users' expired tokens still accumulate. No audit log retention or cleanup policy exists — entries accumulate indefinitely. RBAC management events (role create/delete, permission assign/unassign, user-role changes) are not logged.

## Log

- **Cycle 01:** Set up pnpm monorepo with Hono API and React dashboard. All dev, lint, and test scripts work. See `cycles/01/`
- **Cycle 02:** Added Turso database layer with Drizzle ORM and libsql adapter. Local dev via turso dev CLI, tests via in-memory SQLite, Workers compatibility confirmed. See `cycles/02/`
- **Cycle 03:** Added CI/CD pipeline with GitHub Actions: PR checks (lint + test), per-PR preview deploys, staging on merge to main, production on tag. Hono + React deployed as a single Cloudflare Worker. All 4 criteria verified end-to-end. See `cycles/03/`
- **Cycle 04:** Configured Turso databases for preview, staging, and production. CI/CD deploys now run `drizzle-kit push` before each deploy, and the health endpoint verifies DB connectivity on all environments. See `cycles/04/`
- **Cycle 05:** Implemented per-PR Turso database lifecycle in preview deploys. Cleanup workflow destroys database and worker on PR close. See `cycles/05/`
- **Cycle 06:** Implemented user registration and login with OAuth 2.0-compatible JWT access tokens. All crypto via Web Crypto API with zero new dependencies. All 5 success criteria met with 12 passing tests. See `cycles/06/`
- **Cycle 07:** Added refresh token support with 7-day expiry and revocation. 19 tests pass with zero regressions. See `cycles/07/`
- **Cycle 08:** Added RBAC data model with roles, permissions, and join tables. Four new endpoints for role creation, permission assignment, user-role assignment, and permission resolution. 29 tests pass with zero regressions. See `cycles/08/`
- **Cycle 09:** Built admin dashboard with React Router for RBAC management. All 5 success criteria met with 35 passing tests. See `cycles/09/`
- **Cycle 10:** Added refresh token rotation via revoke-and-reissue. POST /refresh now returns a new refresh token alongside the access token, with the old token invalidated. 37 API tests pass with zero regressions. See `cycles/10/`
- **Cycle 11:** Added eager cleanup of stale refresh tokens during rotation. POST /refresh now deletes all revoked and expired tokens for the user after issuing a new token. 38 API tests pass with zero regressions. See `cycles/11/`
- **Cycle 12:** Added sliding window rate limiting to POST /login (10/60s), POST /register (5/60s), and POST /refresh (10/60s) with Cloudflare KV storage and in-memory fallback. All 7 success criteria met with 44 API tests passing (6 new), zero regressions. See `cycles/12/`
- **Cycle 13:** Added JWT auth middleware to all RBAC endpoints. Requests without a valid Bearer token now receive 401. All 4 success criteria met with 50 API tests passing (6 new), zero regressions. See `cycles/13/`
- **Cycle 14:** Added role-based authorization to all RBAC endpoints via requirePermission middleware. POST /seed bootstraps admin role with manage_roles and manage_users permissions. All 4 success criteria met with 58 API tests passing (8 new), zero regressions. See `cycles/14/`
- **Cycle 15:** Added 27 E2E journey tests across 3 files validating all user-facing API workflows (auth lifecycle, admin RBAC setup, error paths). All 3 success criteria met with 85 API tests passing (27 new), zero regressions. See `cycles/15/`
- **Cycle 16:** Added dashboard authentication with login page, protected routes, and JWT-bearing API calls via AuthContext provider and useApiFetch hook. All 4 success criteria met with 92 tests passing (7 new dashboard, 85 API), zero regressions. See `cycles/16/`
- **Cycle 17:** Added automatic token refresh to dashboard — useApiFetch intercepts 401 responses, refreshes the access token via POST /refresh, and retries the original request transparently. All 4 success criteria met with 97 tests passing (5 new dashboard, 85 API), zero regressions. See `cycles/17/`
- **Cycle 18:** Added localStorage token persistence via a tokenStorage abstraction module wired into AuthContext. Auth state now survives page reloads and new browser tabs. All 4 success criteria met with 107 tests passing (10 new dashboard, 85 API, 12 existing dashboard), zero regressions. See `cycles/18/`
- **Cycle 19:** Added delete and edit CRUD for roles and role assignments across API and dashboard. Three new endpoints (DELETE /roles/:roleId with 409 conflict, PUT /roles/:roleId, DELETE /users/:userId/roles/:roleId), dashboard delete/edit/remove UI, and enhanced permissions endpoint to return assigned roles. All 8 success criteria met with 131 tests passing (24 new), zero regressions. See `cycles/19/`
- **Cycle 20:** Added audit logging for all auth and authz events. New audit_logs table, writeAuditLog utility with best-effort error handling, audit entries from register/login/refresh/revoke handlers and requirePermission middleware (authz_granted/authz_denied), and GET /audit-logs endpoint with pagination and event_type filtering. All 5 success criteria met with 149 tests passing (18 new), zero regressions. See `cycles/20/`
- **Cycle 21:** Added password reset with POST /forgot-password and POST /reset-password endpoints, new password_reset_tokens table, 1-hour token expiry, single-use enforcement, user enumeration prevention, and audit logging for all reset events. All 6 success criteria met with 162 tests passing (13 new), zero regressions. See `cycles/21/`
- **Cycle 22:** Added audit logs dashboard page at /audit-logs with paginated table view, event_type filter dropdown, and auth protection via ProtectedRoute. All 5 success criteria met with 172 tests passing (10 new), zero regressions. See `cycles/22/`
- **Cycle 23:** Added API key management with POST /api-keys (create with crb_ prefix, SHA-256 hash storage), GET /api-keys (list masked), DELETE /api-keys/:keyId (soft revoke), and auth middleware extension for API key Bearer authentication via hash lookup. All 5 success criteria met with 189 tests passing (17 new), zero regressions. See `cycles/23/`
- **Cycle 24:** Added API keys dashboard page at /api-keys with key list table, create form with one-time raw key display, and revoke button. All 5 success criteria met with 200 tests passing (11 new), zero regressions. See `cycles/24/`
- **Cycle 25:** Added admin bootstrap dashboard page at /setup with optimistic seed pattern — button decodes JWT to extract userId and calls POST /seed, handles 409 as already-configured. Plan deviated from check-then-render to optimistic pattern due to GET /roles permission chicken-and-egg. All 4 success criteria met with 210 tests passing (10 new), zero regressions. See `cycles/25/`
- **Cycle 26:** Added navigation sidebar to dashboard with NavLink active-state highlighting for 5 top-level pages. Layout restructured from top-nav links to sidebar+content flexbox. All 4 success criteria met with 216 tests passing (6 new), zero regressions. See `cycles/26/`
- **Cycle 27:** Secured POST /seed behind ADMIN_SETUP_TOKEN environment variable via X-Setup-Token header guard. Returns 401 if token is missing, wrong, or env var unconfigured. All 3 success criteria met with 220 tests passing (4 new), zero regressions. See `cycles/27/`
